{% extends 'base.html' %}
{%- block title %}{{ page_title|safe }}{%- endblock %}
{%- block content %}
{% include 'date_range.html' %}
<div class="row">
    <div class="col-lg-12">
        <div class="page-header">
        <h3>Failed Builds</h3>
        </div>
        <table id="failed-builds" class="table table-striped table-condensed">
            <thead>
                <tr>
                    <th>Tree &dash; Branch</th>
                    <th>Kernel</th>
                    <th>Date</th>
                    <th></th>
                </tr>
            <thead>
            <tbody id="failed-builds-body">
                <tr>
                    <td colspan="4" align="center" valign="middle">
                        <i class="fa fa-cog fa-spin fa-2x"></i>&nbsp;loading&hellip;
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4">
                    <span rel="tooltip" data-toggle="tooltip" title="View all available builds">
                        <a href="/build">All builds</a>
                    </span>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="page-header">
        <h3>Failed Jobs</h3>
        </div>
        <table id="failed-jobs" class="table table-striped table-condensed">
            <thead>
                <tr>
                    <th>Tree &dash; Branch</th>
                    <th>Kernel</th>
                    <th>Date</th>
                    <th></th>
                </tr>
            <thead>
            <tbody id="failed-jobs-body">
                <tr>
                    <td colspan="4" align="center" valign="middle">
                        <i class="fa fa-cog fa-spin fa-2x"></i>&nbsp;loading&hellip;
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4">
                    <span rel="tooltip" data-toggle="tooltip" title="View all available jobs">
                    <a href="/job">All jobs</a>
                    </span>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="page-header">
        <h3>Failed Boot Reports</h3>
        </div>
        <table id="failed-boots" class="table table-striped tabled-condensed">
            <thead>
                <tr>
                    <th>Tree</th>
                    <th>Kernel</th>
                    <th>Board</th>
                    <th>Defconfig</th>
                    <th>Date</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="failed-boots-body">
                <tr>
                    <td colspan="6" align="center" valign="middle">
                        <i class="fa fa-cog fa-spin fa-2x"></i>&nbsp;loading&hellip;
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="6">
                    <span rel="tooltip" data-toggle="tooltip" title="View all available boot reports">
                    <a href="/boot">All boot reports</a>
                    </span>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{%- endblock %}
{%- block scripts %}
{{ super() }}
<script type="text/javascript" src="/static/js/linaro-jslib-1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    $('#li-home').addClass('active');
    $('body').tooltip({
        'selector': '[rel=tooltip]',
        'placement': 'auto'
    });

    $.ajax({
        'url': '/_ajax/defconf',
        'traditional': true,
        'dataType': 'json',
        'context': $('#failed-builds-body'),
        'data': {
            'limit': 5,
            'status': 'FAIL',
            'sort': 'created_on',
            'sort_order': -1,
            'date_range': 15,
            'field': ['job', 'kernel', 'metadata', 'created_on']
        },
        'dataFilter': function(data, type) {
            if (type === 'json') {
                return $.parseJSON(data).result;
            } else {
                return data;
            }
        }
    }).done(function(data) {
        var row = '',
            job, created, col1, col2, col3, col4,
            kernel, git_branch,
            i = 0,
            len = data.length;

        $(this).empty();

        if (len === 0) {
            row = '<tr><td colspan="4" align="center" valign="middle"><h4>' +
                'No failed builds.</h4></td></tr>';
            $(this).append(row);
        } else {
            for (i; i < len; i++) {
                job = data[i].job;
                kernel = data[i].kernel;
                git_branch = data[i].metadata.git_branch;
                created = new Date(data[i].created_on['$date']);

                col1 = '<td>' + job + '&nbsp;&dash;&nbsp;<small>' +
                    git_branch + '</small></td>';
                col2 = '<td>' + kernel + '</td>';
                col3 = '<td>' + created.getCustomISODate() + '</td>';
                col4 = '<td>' +
                    '<span rel="tooltip" data-toggle="tooltip" ' +
                    'title="Details for job&nbsp;' + job +
                    '&nbsp;&dash;&nbsp;' + kernel + '">' +
                    '<a href="/job/' + job + '/kernel/' + kernel + '/">' +
                    '<i class="fa fa-search"></i></a>' +
                    '</span></td>';
                row += '<tr>' + col1 + col2 + col3 + col4 + '</tr>';
            }

            $(this).append(row);
        }
    });

    $.ajax({
        'url': '/_ajax/job',
        'dataType': 'json',
        'traditional': true,
        'context': $('#failed-jobs-body'),
        'data': {
            'limit': 5,
            'status': 'FAIL',
            'sort': 'created_on',
            'sort_order': -1,
            'date_range': 15,
            'field': ['job', 'kernel', 'created_on', 'metadata']
        },
        'dataFilter': function(data, type) {
            if (type === 'json') {
                return $.parseJSON(data).result;
            } else {
                return data;
            }
        }
    }).done(function(data) {
        var row = '',
            created, col1, col2, col3, col4,
            job, kernel, git_branch,
            i = 0,
            len = data.length;

        $(this).empty();

        if (len === 0) {
            row = '<tr><td colspan="4" align="center" valign="middle"><h4>' +
                'No failed jobs.</h4></td></tr>';
            $(this).append(row);
        } else {
            for (i; i < len; i++) {
                created = new Date(data[i].created_on['$date']);
                job = data[i].job;
                kernel = data[i].kernel;
                git_branch = data[i].metadata.git_branch;

                col1 = '<td>' + job + '&nbsp;&dash;&nbsp;<small>' +
                    git_branch + '</small>' + '</td>';
                col2 = '<td>' + kernel + '</td>';
                col3 = '<td>' + created.getCustomISODate() + '</td>';
                col4 = '<td>' +
                    '<span rel="tooltip" data-toggle="tooltip" ' +
                    'title="Details for job&nbsp;' + job +
                    '&nbsp;&dash;&nbsp;' + kernel + '">' +
                    '<a href="/job/' + job + '/kernel/' + kernel + '/">' +
                    '<i class="fa fa-search"></i></a>' +
                    '</span></td>';
                row = '<tr>' + col1 + col2 + col3 + col4 + '</tr>';
            }

            $(this).append(row);
        }
    });

    $.ajax({
        'url': '/_ajax/boot',
        'traditional': true,
        'dataType': 'json',
        'context': $('#failed-boots-body'),
        'data': {
            'limit': 15,
            'status': 'FAIL',
            'sort_order': -1,
            'sort': 'created_on',
            'field': ['board', 'job', 'kernel', 'defconfig', 'created_on']
        },
        'dataFilter': function(data, type) {
            if (type === 'json') {
                return $.parseJSON(data).result;
            } else {
                return data;
            }
        }
    }).done(function(data) {
        var row = '',
            created, board, job, kernel, defconfig,
            col1, col2, col3, col4, col5, col6,
            len = data.length,
            i = 0;

        $(this).empty();

        if (len === 0) {
            row = '<tr><td colspan="6" align="center" valign="middle"><h4>' +
                'No failed boot reports.</h4></td></tr>';
            $(this).append(row);
        } else {
            for (i; i < len; i++) {
                created = new Date(data[i].created_on['$date']);
                job = data[i].job;
                kernel = data[i].kernel;
                board = data[i].board;
                defconfig = data[i].defconfig;

                col1 = '<td>' + job + '</td>';
                col2 = '<td>' + kernel + '</td>';
                col3 = '<td>' + board + '</td>';
                col4 = '<td>' + defconfig + '</td>';
                col5 = '<td>' + created.getCustomISODate() + '</td>';
                col6 = '<td>' +
                    '<span rel="tooltip" data-toggle="tooltip" ' +
                    'title="Details for board&nbsp;' + board + '">' +
                    '<a href="/boot/' + board + '/job/' + job + '/kernel/' +
                    kernel + '/defconfig/' + defconfig + '/">' +
                    '<i class="fa fa-search"></i></a>' +
                    '</span></td>';
                row += '<tr>' + col1 + col2 + col3 + col4 +
                        col5 + col6 + '</tr>';
            }

            $(this).append(row);
        }
    });
});
</script>
{%- endblock %}
