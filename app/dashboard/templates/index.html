{% extends 'base.html' %}
{%- block title %}{{ page_title|safe }}{%- endblock %}
{%- block head %}
{{ super() }}
    <link rel="stylesheet" type="text/css" href="/static/css/datatables.min.css">
{%- endblock %}
{%- block content %}
<div class="row">
    <div class="col-lg-6">
        <h3>Latest Failed Builds <small>(last 15 days)</small></h3>
        <table id="failed-builds" class="table table-striped table-condensed">
            <thead>
                <tr>
                    <th>Tree &dash; Branch</th>
                    <th>Kernel</th>
                    <th>Date</th>
                </tr>
            <thead>
            <tbody id="failed-builds-body"></tbody>
            <tfoot>
                <tr>
                    <td colspan="3">
                    <span rel="tooltip" data-toggle="tooltip" title="View all available builds">
                        <small><a href="/build">All builds</a></small>
                    </span>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
    <div class="col-lg-6">
        <h3>Latest Failed Jobs <small>(last 15 days)</small></h3>
        <table id="failed-jobs" class="table table-striped table-condensed">
            <thead>
                <tr>
                    <th>Tree &dash; Branch</th>
                    <th>Kernel</th>
                    <th>Date</th>
                </tr>
            <thead>
            <tbody id="failed-jobs-body"></tbody>
            <tfoot>
                <tr>
                    <td colspan="3">
                    <span rel="tooltip" data-toggle="tooltip" title="View all available jobs">
                    <small><a href="/job">All jobs</a></small>
                    </span>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <h3>Latest Boot Reports</h3>
    </div>
</div>
{%- endblock %}
{%- block scripts %}
{{ super() }}
<script type="text/javascript" src="/static/js/kernelci.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    $('#li-home').addClass("active");
    $('body').tooltip({
        'selector': '[rel=tooltip]',
        'placement': 'auto',
    });

    $.ajax({
        'url': '/_ajax/defconf',
        'type': 'GET',
        'traditional': true,
        'context': $('#failed-builds-body'),
        'data': {
            'limit': 5,
            'status': 'FAILED',
            'sort': 'created',
            'field': ['job', 'kernel', 'metadata', 'created'],
        },
    }).done(function(data) {
        var defconfs = data['result'];

        $(this).empty();

        if (defconfs.length == 0) {
            var row = '<tr><td colspan="3" align="center" valign="middle"><h4>' +
                    'No failed builds.</h4></td></tr>';
            $(this).append(row);
        } else {
            for (var i = 0; i < defconfs.length; i++) {
                var job = defconfs[i]['job'];

                var created = new Date(defconfs[i]['created']),
                    col1 = '<td>' +
                        '<span rel="tooltip" data-toggle="tooltip" title="Details for job&nbsp;' + job + '">' +
                        '<a href="/job/' + job + '">' + job + '&nbsp;&dash;&nbsp;<small>' + defconfs[i]['metadata']['git_branch'] + '</small>' +'</a></span></td>',
                    col2 = '<td>' +
                        '<span rel="tooltip" data-toggle="tooltip" title="Details for&nbsp;' + job + '&nbsp;&dash;&nbsp;' + defconfs[i]['kernel'] + '"><a href="/job/' + job + '/kernel/' + defconfs[i]['kernel'] + '">' +
                        defconfs[i]['kernel'] + '</a></td>',
                    col3 = '<td>' + created.getCustomISODate() + '</td>',
                    col4 = '<td>' +
                        '<span rel="tooltip"',
                    row = '<tr>' + col1 + col2 + col3 + '</tr>';

                $(this).append(row);
            };
        };
    });

    $.ajax({
        'url': '/_ajax/job',
        'type': 'GET',
        'traditional': true,
        'context': $('#failed-jobs-body'),
        'data': {
            'limit': 5,
            'status': 'FAILED',
            'sort': 'created',
            'field': ['job', 'kernel', 'created', 'metadata'],
        },
    }).done(function(data) {
        var jobs = data['result'];

        $(this).empty();

        if (jobs.length == 0) {
            var row = '<tr><td colspan="3" align="center" valign="middle"><h4>' +
                    'No failed jobs.</h4></td></tr>';
            $(this).append(row);
        } else {
            for (var i = 0; i < jobs.length; i++) {
                var created = new Date(jobs[i]['created']),
                    col1 = '<td>' + jobs[i]['job'] + '&nbsp;&dash;&nbsp;<small>' + jobs[i]['metadata']['git_branch'] + '</small>' +'</td>',
                    col2 = '<td>' + jobs[i]['kernel'] + '</td>',
                    col3 = '<td>' + created.getCustomISODate() + '</td>',
                    row = '<tr>' + col1 + col2 + col3 + '</tr>';

                $(this).append(row);
            };
        };
    });
});
</script>
{%- endblock %}